name: AI Translator (Template Logic)

on:
  push:
    branches: ["main"]
    paths:
      - '**.md'

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Python Kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: OpenAI KÃ¼tÃ¼phanesi
        run: pip install openai

      - name: AkÄ±llÄ± Ã‡eviri ve Linkleme
        env:
          GITHUB_TOKEN: ${{ secrets.OPENAI_API_KEY }}
        shell: python
        run: |
          import os
          import sys
          import re
          from openai import OpenAI

          # --- 1. AYARLAR ---
          endpoint = "https://models.github.ai/inference"
          token = os.environ.get("GITHUB_TOKEN")
          
          if not token:
              print("::error::Token bulunamadi!")
              sys.exit(1)

          client = OpenAI(base_url=endpoint, api_key=token)
          file_name = "README.md"
          
          if not os.path.exists(file_name):
              sys.exit(0)

          # --- 2. LÄ°NKLERÄ° HAZIRLA (Referans aldÄ±ÄŸÄ±nÄ±z ÅŸablon mantÄ±ÄŸÄ±) ---
          
          # Ana Sayfa (Root) iÃ§in Link BloÄŸu:
          # BurasÄ± ana dizin olduÄŸu iÃ§in yollar dÃ¼zdÃ¼r (README.md)
          header_root = """[ ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e ](README.md) | [ ğŸ‡ºğŸ‡¸ English ](translations/en/README.md)
          """

          # Ä°ngilizce Dosya (Nested) iÃ§in Link BloÄŸu:
          # BurasÄ± "translations/en/" iÃ§inde olduÄŸu iÃ§in 2 adÄ±m geri Ã§Ä±kmalÄ± (../../)
          header_en = """[ ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e ](../../README.md) | [ ğŸ‡ºğŸ‡¸ English ](README.md)
          """

          # --- 3. ANA DOSYAYI GÃœNCELLE ---
          with open(file_name, "r", encoding="utf-8") as f:
              content = f.read()

          # EÄŸer etiketler zaten varsa, iÃ§ini gÃ¼ncelle; yoksa baÅŸa ekle.
          if "" in content:
              # Mevcut tabloyu Regex ile bul ve bizim standart ÅŸablonla deÄŸiÅŸtir
              pattern = r".*?"
              content = re.sub(pattern, header_root.strip(), content, flags=re.DOTALL)
          else:
              # HiÃ§ yoksa en tepeye ekle
              content = header_root.strip() + "\n\n" + content

          # Ana dosyayÄ± (TÃ¼rkÃ§e) linklerle beraber kaydet
          with open(file_name, "w", encoding="utf-8") as f:
              f.write(content)

          # --- 4. Ã‡EVÄ°RÄ°YE HAZIRLIK ---
          # Ã‡eviriye gÃ¶nderirken linkleri Ã‡IKARIYORUZ. 
          # Ã‡Ã¼nkÃ¼ GPT linkleri bozabilir veya "Turkish" kelimesini Ã§evirebilir.
          text_to_translate = content.split("")[-1].strip()

          print("Ã‡eviri yapÄ±lÄ±yor (GPT-4o)...")
          try:
              response = client.chat.completions.create(
                  messages=[
                      {"role": "system", "content": "You are a professional technical translator. Translate the markdown content to English. Do not explain. Preserve code blocks exactly."},
                      {"role": "user", "content": text_to_translate}
                  ],
                  model="gpt-4o",
                  temperature=0.1
              )
              translated_body = response.choices[0].message.content
              
              # --- 5. Ä°NGÄ°LÄ°ZCE DOSYAYI OLUÅTUR ---
              # Ä°ÅŸte burasÄ± kritik: Ä°ngilizce metnin tepesine "header_en" (../../ olan) ekliyoruz.
              final_english_content = header_en.strip() + "\n\n" + translated_body
              
              os.makedirs("translations/en", exist_ok=True)
              output_path = f"translations/en/{file_name}"
              
              with open(output_path, "w", encoding="utf-8") as f:
                  f.write(final_english_content)
                  
              print(f"BAÅARILI! Linkler ve iÃ§erik {output_path} konumuna yazÄ±ldÄ±.")

          except Exception as e:
              print(f"::error::Hata: {e}")
              sys.exit(1)

      - name: DeÄŸiÅŸiklikleri GÃ¶nder
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ¤– Template MantÄ±ÄŸÄ± ile Linkler DÃ¼zeltildi" || echo "DeÄŸiÅŸiklik yok"
          git push
