name: AI Translator (Fixed Split)

on:
  push:
    branches: ["main"]
    paths:
      - '**.md' # Herhangi bir MD dosyasÄ± deÄŸiÅŸince tetiklenir

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Python Kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Gerekli KÃ¼tÃ¼phaneler
        run: pip install openai

      - name: Toplu Ã‡eviri Scripti
        env:
          GITHUB_TOKEN: ${{ secrets.OPENAI_API_KEY }}
        shell: python
        run: |
          import os
          import sys
          import re
          from openai import OpenAI

          # --- 1. AYARLAR VE SABÄ°TLER ---
          endpoint = "https://models.github.ai/inference"
          token = os.environ.get("GITHUB_TOKEN")
          model_name = "gpt-4o"
          
          # HATA Ã‡Ã–ZÃœMÃœ: Etiketleri buraya deÄŸiÅŸken olarak aldÄ±k
          TAG_START = ""
          TAG_END = ""

          if not token:
              print("::error::Token bulunamadi! Secret ayarlarini kontrol edin.")
              sys.exit(1)

          client = OpenAI(base_url=endpoint, api_key=token)

          # --- 2. DOSYALARI BULMA ---
          # KÃ¶k dizindeki tÃ¼m .md dosyalarÄ±nÄ± al (translations klasÃ¶rÃ¼ hariÃ§)
          md_files = [f for f in os.listdir('.') if f.endswith('.md') and os.path.isfile(f)]

          if not md_files:
              print("Ä°ÅŸlenecek .md dosyasÄ± bulunamadÄ±.")
              sys.exit(0)

          print(f"Bulunan dosyalar: {md_files}")

          # --- 3. DÃ–NGÃœ BAÅLIYOR ---
          for file_name in md_files:
              print(f"\n--- Ä°ÅŸleniyor: {file_name} ---")

              # Link ÅablonlarÄ± (DeÄŸiÅŸkenleri kullanarak)
              header_root = f"""{TAG_START}
          [ ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e ]({file_name}) | [ ğŸ‡ºğŸ‡¸ English ](translations/en/{file_name})
          {TAG_END}
          """
              header_en = f"""{TAG_START}
          [ ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e ](../../{file_name}) | [ ğŸ‡ºğŸ‡¸ English ]({file_name})
          {TAG_END}
          """

              # DosyayÄ± Oku
              try:
                  with open(file_name, "r", encoding="utf-8") as f:
                      content = f.read()
              except Exception as e:
                  print(f"::error::{file_name} okunamadÄ±: {e}")
                  continue

              # Ana Dosyaya Link Ekleme
              if TAG_START in content:
                  # Regex yerine dÃ¼z string deÄŸiÅŸimi daha gÃ¼venli olabilir ama pattern koruyoruz
                  pattern = f"{TAG_START}.*?{TAG_END}"
                  content = re.sub(pattern, header_root.strip(), content, flags=re.DOTALL)
              else:
                  content = header_root.strip() + "\n\n" + content

              with open(file_name, "w", encoding="utf-8") as f:
                  f.write(content)

              # Ã‡eviri HazÄ±rlÄ±ÄŸÄ± (HATA Ã‡IKAN YER DÃœZELTÄ°LDÄ°)
              # ArtÄ±k TAG_END deÄŸiÅŸkenini kullanÄ±yoruz, string boÅŸ gelme ÅŸansÄ± yok.
              if TAG_END in content:
                  text_to_translate = content.split(TAG_END)[-1].strip()
              else:
                  # EÄŸer tag eklenememiÅŸse (imkansÄ±z ama gÃ¼venlik Ã¶nlemi) tÃ¼m iÃ§eriÄŸi al
                  text_to_translate = content

              # BoÅŸ iÃ§erik kontrolÃ¼
              if not text_to_translate:
                  print(f"UYARI: {file_name} iÃ§inde Ã§evrilecek metin bulunamadÄ±.")
                  continue

              # Yapay Zeka Ã‡aÄŸrÄ±sÄ±
              try:
                  response = client.chat.completions.create(
                      messages=[
                          {"role": "system", "content": "You are a professional technical translator. Translate the markdown content to English. Do not explain. Preserve code blocks exactly."},
                          {"role": "user", "content": text_to_translate}
                      ],
                      model=model_name,
                      temperature=0.1
                  )
                  translated_body = response.choices[0].message.content
                  
                  # Ä°ngilizce Kaydetme
                  final_english_content = header_en.strip() + "\n\n" + translated_body
                  
                  os.makedirs("translations/en", exist_ok=True)
                  output_path = f"translations/en/{file_name}"
                  
                  with open(output_path, "w", encoding="utf-8") as f:
                      f.write(final_english_content)
                      
                  print(f"âœ… {file_name} baÅŸarÄ±yla Ã§evrildi.")

              except Exception as e:
                  print(f"::error::{file_name} Ã§evrilirken hata: {e}")
                  continue

      - name: GitHub'a GÃ¶nder (Push)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ¤– TÃ¼m Belgeler Ã‡evrildi" || echo "DeÄŸiÅŸiklik yok"
          git push
