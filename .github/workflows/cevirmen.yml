name: AI Translator (Custom Script)

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.md'

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Python Kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Gerekli KÃ¼tÃ¼phaneyi Kur
        run: pip install openai

      - name: Ã‡eviri Ä°ÅŸlemi (Python Script)
        env:
          # Secret'Ä± burada "MY_API_KEY" adÄ±yla iÃ§eri alÄ±yoruz
          MY_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        shell: python
        run: |
          import os
          from openai import OpenAI

          print("--- 1. Anahtar KontrolÃ¼ ---")
          api_key = os.environ.get("MY_API_KEY")
          
          if not api_key:
              print("::error::Anahtar (Secret) hic bulunamadi!")
              exit(1)
          
          # AnahtarÄ±n baÅŸÄ±nÄ± kontrol et (GÃ¼venlik iÃ§in tamamÄ±nÄ± yazdÄ±rmÄ±yoruz)
          if api_key.startswith("github_pat_"):
              print("Anahtar formati DOGRU: github_pat_... ile basliyor.")
          else:
              print(f"UYARI: Anahtar farkli bir formatta: {api_key[:5]}...")

          print("--- 2. Baglanti Kuruluyor ---")
          try:
              client = OpenAI(
                  base_url="https://models.inference.ai.azure.com",
                  api_key=api_key
              )
              
              # Hedef Dosya
              file_name = "README.md"
              
              if not os.path.exists(file_name):
                  print(f"HATA: {file_name} bulunamadi.")
                  exit(0)

              print(f"--- 3. {file_name} Okunuyor ---")
              with open(file_name, "r", encoding="utf-8") as f:
                  content = f.read()

              # Linkleri ekle (EÄŸer yoksa)
              if "" not in content:
                  print("Linkler ekleniyor...")
                  header = "\n[ ðŸ‡¹ðŸ‡· Turkish ](README.md) | [ ðŸ‡ºðŸ‡¸ English ](translations/en/README.md)\n\n\n"
                  content = header + content
                  # Orijinal dosyayÄ± gÃ¼ncelle
                  with open(file_name, "w", encoding="utf-8") as f:
                      f.write(content)

              print("--- 4. Yapay Zekaya Gonderiliyor (GPT-4o) ---")
              response = client.chat.completions.create(
                  model="gpt-4o",
                  messages=[
                      {"role": "system", "content": "You are a professional technical translator. Translate the markdown content to English. Preserve code blocks exactly."},
                      {"role": "user", "content": content}
                  ]
              )
              
              translated_text = response.choices[0].message.content
              
              # Kaydet
              os.makedirs("translations/en", exist_ok=True)
              output_path = f"translations/en/{file_name}"
              
              with open(output_path, "w", encoding="utf-8") as f:
                  f.write(translated_text)
              
              print(f"--- 5. BASARILI! Dosya kaydedildi: {output_path} ---")

          except Exception as e:
              print(f"::error::Python Hatasi: {e}")
              exit(1)

      - name: Kaydet ve GÃ¶nder
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ðŸ¤– Custom Script ile Ã‡eviri YapÄ±ldÄ±" || echo "DeÄŸiÅŸiklik yok"
          git push
